---
title: "Maps"
author: "Silvia Ventoruzzo"
date: "27/11/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setenv(LANG = "en")
Sys.setlocale("LC_ALL", "en_US.UTF-8")
```

```{r, include=FALSE}
source("01_functions.R")
library(pacman)
# p_load(raster)
p_load(dplyr)
p_load(sp)
# p_load(rgdal)
# To avoid issue Error in unionSpatialPolygons(berlin, berlin$BEZNAME) : isTRUE(gpclibPermitStatus()) is not TRUE, install rgeos, and ensure that it was attached prior to attaching maptools
p_load(rgeos)
# p_load(maptools)
p_load(sf)
# p_load(DescTools)
p_load(data.table)
p_load(leaflet)
# p_load(lwgeom)
p_load(colorspace)
p_load(ggplot2)

# p_load(tidyverse)

# p_load(Tmisc)
# p_load(htmltools)
# p_load(sp)
# p_load(rgdal)




# library(XML)

# library(Hmisc)

```


## Creating Spatial Objects for mapping

Load shapefiles
```{r}
berlin <- raster::shapefile(file.path(getwd(), "spatial_data", "Berlin-Ortsteile-polygon.shp", fsep="/"))
stations <- raster::shapefile(file.path(getwd(), "spatial_data", "gis_osm_transport_free_1.shp", fsep="/"))
```

# Create sf objects with districts and neighbourhoods
```{r}
# Object with the neightbourhoods (and respective district)
berlin_neighbourhood_sf <- berlin %>%
  sf::st_as_sf() %>% # Transform into sf Object
  sf::st_set_crs(proj4string(berlin)) %>% # add Coordinate Reference System (CRM)
  dplyr::rename(id    = Name,
                group = BEZNAME) %>%
  dplyr::select(id, group, geometry) %>%
  dplyr::arrange(group) %>%
  dplyr::mutate(view = "Neighbourhoods")

# Buckow is composed of two separate parts, so we need to join them
berlin_neighbourhood_singlebuckow_sf <- berlin_neighbourhood_sf %>%
  dplyr::group_by(id, group, view) %>%
  dplyr::summarize(do_union = TRUE) %>%
  dplyr::arrange(group)

# Object with the districts: we need to group by "group" (BEZNAME)
berlin_district_sf <- berlin_neighbourhood_sf %>%
  dplyr::group_by(group, view) %>%
  dplyr::summarize(do_union = TRUE) %>%
  dplyr::mutate(id    = group,
                view  = "Districts")
```

# Create polygons for VBB Areas
VBB areas are the one related to public transportation.
Area A is delimited by the Ringbahn.
Area B starts from the Ringbahn and covers the rest of Berlin.
Area C will not be displayed since it is in Brandenburg.


```{r}
# Create SpatialPolygons of all Berlin
berlin_all_sf <- raster::aggregate(berlin, dissolve=TRUE) %>%
  sf::st_as_sf() %>%
  sf::st_set_crs(proj4string(berlin))

# Create dataframe of train/subway stations out of SpatialPointsDataFrame
bahn_stations_df <- stations %>%
  base::as.data.frame() %>% 
  dplyr::filter(fclass %like% "railway") %>%
  dplyr::rename(id   = name,
                long = coords.x1,
                lat  = coords.x2) %>%
  dplyr::mutate(id     = gsub("Berlin ", "", id),
                id     = gsub("Berlin-", "", id),
                id     = gsub(" *\\(.*?\\) *", "", id),
                s_bahn = ifelse(startsWith(id, "S "), TRUE, FALSE),
                u_bahn = ifelse(startsWith(id, "U "), TRUE, FALSE),
                id     = gsub("S ", "", id),
                id     = gsub("U ", "", id)) %>%
  dplyr::group_by(id) %>%
  dplyr::summarize(long = mean(long), lat = mean(lat),
                  s_bahn = any(s_bahn), u_bahn = any(u_bahn))
  
# Create DF with Ringbahn stations and their order
# The initial station is repeated to have a full circle
ringbahn_names_df <- base::data.frame(id = c("Südkreuz", "Schöneberg", "Innsbrucker Platz", "Bundesplatz",
                    "Heidelberger Platz", "Hohenzollerndamm", "Halensee", "Westkreuz",
                    "Messe Nord/ICC", "Westend", "Jungfernheide", "Beusselstraße",
                    "Westhafen", "Wedding", "Gesundbrunnen", "Schönhauser Allee",
                    "Prenzlauer Allee", "Greifswalder Straße", "Landsberger Allee", 
                    "Storkower Straße", "Frankfurter Allee", "Ostkreuz", "Treptower Park",
                    "Sonnenallee", "Neukölln", "Hermannstraße",
                    "Tempelhof", "Südkreuz"),
                    stringsAsFactors = FALSE) %>% 
  tibble::rownames_to_column(var = "order") %>%
  dplyr::mutate(order = as.numeric(order))

# Create the sf object for the VBB Areas
vbb_AB_sf <- bahn_stations_df %>%
  # Right Join so only the stations in ringbahn_names_df remain
  dplyr::right_join(ringbahn_names_df, by = "id") %>%
  # Rearrange according to the order we inserted before (in case it doesn't work automatically in the join)
  dplyr::arrange(order) %>%
  dplyr::select(long, lat) %>%
  # Transform the points into a polygon
  base::as.matrix() %>%
  base::list() %>%
  sf::st_polygon() %>%
  st_sfc() %>%
  st_sf(crs = proj4string(berlin)) %>%
  # Join with the polygon of whole Berlin
  base::rbind(berlin_all_sf) %>%
  # Calculate intersections
  sf::st_intersection() %>% 
  # Define IDs for different areas
  dplyr::mutate(id    = ifelse(n.overlaps > 1, "A", "B"), 
                view  = "VBB Areas",
                group = id) %>% 
  dplyr::select(-n.overlaps, -origins) %>%
  dplyr::arrange(desc(id))

# ALTERNATIVE WAY
# ringbahn_sf <- sp::SpatialPolygons(list(Polygons(list(Polygon(ringbahn_df %>% dplyr::select(long, lat))),
#                                              ID = "A")),
#                                proj4string = CRS(proj4string(berlin))) %>%
#   sf::st_as_sf() 
```

Join the sf objects
```{r}
berlin_sf <- base::rbind(berlin_district_sf, vbb_AB_sf, berlin_neighbourhood_singlebuckow_sf) %>%
    sf::st_cast(to = 'MULTIPOLYGON')
```

Create a DF with the names of the areas and coordinates where to show them
```{r}
# Names with coordinates
berlin_names <- berlin_sf %>%
  dplyr::filter(!id %in% c("B", "Buckow")) %>%
  sf::st_centroid() %>%
  as.data.frame() %>%
  tidyr::extract(geometry, c("long", "lat"), "\\((.*), (.*)\\)", remove = TRUE) %>%
  dplyr::mutate(leaflet = gsub("-", "-<br/>", id),
                ggplot  = gsub("-", "- \n ", id),
                lat     = as.numeric(lat),
                long    = as.numeric(long))

# The coordinates for VBB Area B are calculated differently
# We don't want the name at the center, but on the top part
vbb_B <- berlin_all_sf %>%
  st_bbox() %>%
  as.matrix() %>%
  t() %>%
  as.data.frame() %>%
  dplyr::transmute(long = (xmax + xmin)/2,
                   lat  = (3*ymax + ymin)/4) %>%
  dplyr::mutate(id      = "B",
                group   = id,
                view    = "VBB Areas",
                leaflet = gsub("-", "-<br/>", id),
                ggplot  = gsub("-", "- \n ", id)) 

# The coordinates for Neighourhood Buckow are calculated separately
# We want the name to appear on both separate parts of the neighbourhood
buckow <- berlin_neighbourhood_sf %>%
  dplyr::filter(id == "Buckow") %>%
  sf::st_centroid() %>%
  as.data.frame() %>%
  tidyr::extract(geometry, c("long", "lat"), "\\((.*), (.*)\\)", remove = TRUE) %>%
  dplyr::mutate(leaflet = gsub("-", "-<br/>", id),
                ggplot  = gsub("-", "- \n ", id),
                view    = "Neighbourhoods",
                lat     = as.numeric(lat),
                long    = as.numeric(long))

berlin_names <- berlin_names %>%
  rbind(vbb_B, buckow)

# Calculating the center of Berlin for setView
berlin_center <- methods::slot(berlin, "bbox") %>%
  base::as.data.frame() %>%
  dplyr::transmute(center = (max + min)/2,
                   coords = c("long", "lat")) %>%
  tidyr::spread(key = coords, value = center)
```

```{r}
# leaflet
# colorlist = list("blue", "green", "yellow", "orange", "pink", "brown", "purple", "grey", "black", "darkblue", "khaki", "magenta")
# leaflet() %>%
#   addTiles() %>%
#   addPolygons(data = berlin_sf %>% filter(view == "Districts"), weight = 1, smoothFactor = 1, fillOpacity = 0.8,
#               fillColor = rainbow_hcl(12), color = "grey") %>%
#   addLabelOnlyMarkers(data = berlin_names %>% filter(view == "Districts"),
#                     lng = ~long, lat = ~lat, label = ~lapply(leaflet, htmltools::HTML),
#                     labelOptions = labelOptions(noHide = TRUE, direction = 'center',
#                                                 textOnly = TRUE, textsize = "20px"))

# Leaflet.markercluster
# From: https://github.com/Leaflet/Leaflet.markercluster
# https://rpubs.com/bhaskarvk/leaflet-marker-clusterming


# leaflet() %>%
#   addTiles() %>%
#   addPolygons(data = berlin_sf %>% filter(group == "Neukölln",
#                                           view == "Neighbourhoods"), 
#               weight = 1, smoothFactor = 1, fillOpacity = 0.8,
#               fillColor = rainbow_hcl(6), color = "grey") %>%
#   addLabelOnlyMarkers(data = berlin_names %>% filter(group == "Neukölln", view == "Neighbourhoods"),
#                     lng = ~long, lat = ~lat, label = ~lapply(leaflet, htmltools::HTML),
#                     labelOptions = labelOptions(noHide = TRUE, direction = 'center',
#                                                 textOnly = TRUE, textsize = "20px")) %>%
#   addAwesomeMarkers(data = bahn_stations_df %>% filter(district == "Neukölln"),
#              lng = ~long, lat = ~lat,
#              icon = makeAwesomeIcon(icon = "subway", library = "fa", markerColor = "green", iconColor = "#FFFFFF"),
#              clusterId = "stations",
#              clusterOptions = markerClusterOptions(
#                iconCreateFunction=JS("function (cluster) {    
#     var childCount = cluster.getChildCount();  
#     if (childCount > 1) {  
#       c = 'rgba(181, 226, 140, 1.0);'
#     }    
#     return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', className: 'marker-cluster', iconSize: new L.Point(40, 40) });
# 
#   }"),
#                         singleMarkerMode = FALSE)
#              ) %>%
#     addAwesomeMarkers(data = listings %>% filter(district == "Neukölln"),
#              lng = ~long, lat = ~lat,
#              icon = makeAwesomeIcon(icon = "home", markerColor = "red"),
#              clusterId = "properties",
#              clusterOptions = markerClusterOptions(iconCreateFunction=JS("function (cluster) {    
#     var childCount = cluster.getChildCount();  
#     if (childCount > 1) {  
#       c = 'rgba(235, 0, 0, 1);'
#     }    
#     return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', className: 'marker-cluster', iconSize: new L.Point(40, 40) });
# 
#   }"),
#                         singleMarkerMode = FALSE)) %>%
#   addMiniMap(centerFixed = berlin_center %>% t() %>% c(),
#              zoomLevelFixed = 8,
#              zoomAnimation = FALSE) 
  
# ggplot
# ggplot() + 
#   geom_sf(data = berlin_district_sf, show.legend = FALSE) +
#   coord_sf(datum = NA) +
#   aes(fill = id) +
#   geom_text(data = districts, aes(x = long, y = lat, label = ggplot, hjust = "center"), size = 3.5) + 
#   theme_void()
```

# Map the VBB areas A and B with Leaflet
```{r}
# leaflet() %>%
#   addTiles() %>%
#   addPolygons(data = berlin_sf %>% filter(view == "VBB Areas"), weight = 1, fillColor = c("skyblue", "orange"), 
#               col = "grey",
#               opacity = 1.0, fillOpacity = 0.8) %>%
#   addLabelOnlyMarkers(data = berlin_names %>% filter(view == "VBB Areas"),
#                     lng = ~long, lat = ~lat, label = ~lapply(id, htmltools::HTML),
#                     labelOptions = labelOptions(noHide = TRUE, direction = 'center',
#                                                 textOnly = TRUE, textsize = "25px")) %>%
#   setView(lng = berlin_center$long, lat = berlin_center$lat, zoom = 10)
```

```{r}
rm("ringbahn_names_df", "berlin", "stations", "buckow", "berlin_neighbourhood_singlebuckow_sf", 
   "vbb_B", "berlin_all_sf")
```
