---
title: "Maps"
author: "Silvia Ventoruzzo"
date: "27/11/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setenv(LANG = "en")
Sys.setlocale("LC_ALL", "en_US.UTF-8")
```

```{r, include=FALSE}
source("01_functions.R")
library(pacman)
# p_load(raster)
p_load(dplyr)
# p_load(rgdal)
# To avoid issue Error in unionSpatialPolygons(berlin, berlin$BEZNAME) : isTRUE(gpclibPermitStatus()) is not TRUE, install rgeos, and ensure that it was attached prior to attaching maptools
p_load(rgeos)
p_load(maptools)
p_load(sf)
# p_load(DescTools)
p_load(data.table)
p_load(leaflet)
# p_load(lwgeom)
p_load(colorspace)
p_load(ggplot2)

# p_load(tidyverse)

p_load(Tmisc)
p_load(htmltools)
p_load(sp)
p_load(rgdal)




# library(XML)

# library(Hmisc)

```


## Map with Berlin districts

# Load the shapefile
```{r}
berlin <- raster::shapefile(file.path(getwd(), "mygeodata", "Berlin-Ortsteile-polygon.shp", fsep="/"))
# Calculating the center of Berlin
berlin_center <- methods::slot(berlin, "bbox") %>%
  base::as.data.frame() %>%
  dplyr::transmute(center = (max + min)/2,
                   coords = c("long", "lat")) %>%
  tidyr::spread(key = coords, value = center)
```

# Create sf objects with Berlin districts
The shapefile comes with all Berlin neighbourhoods, but we want to show only the districts
```{r}
# Object with the districts (not neighbourhoods)
berlin_district_sf <- maptools::unionSpatialPolygons(berlin, berlin$BEZNAME) %>% 
  # Join polygons according to district name
  sf::st_as_sf() %>% # Transform into sf Object
  sf::st_set_crs(proj4string(berlin)) %>% # add Coordinate Reference System (CRM)
  dplyr::mutate(id    = berlin$BEZNAME %>% unique() %>% sort(),
                group = id) %>%
  mutate(view = "Districts")

# Object with the neightbourhoods (and respective district)
berlin_neighbourhood_sf <- berlin %>%
  sf::st_as_sf() %>% # Transform into sf Object
  sf::st_set_crs(proj4string(berlin)) %>% # add Coordinate Reference System (CRM)
  dplyr::rename("id"    = "Name",
                "group" = "BEZNAME") %>%
  dplyr::select(id, group, geometry) %>%
  dplyr::arrange(group) %>%
  dplyr::mutate(view = "Neighbourhoods")

# Buckow is composed of two separate parts, so we need to join them
buckow_sf <- berlin_neighbourhood_sf %>%
  dplyr::filter(id == "Buckow") %>%
  sf::st_combine() %>%
  sf::st_sf() %>%
  dplyr::mutate(id    = "Buckow",
                group = "Neukölln",
                view  = "Neighbourhoods")

berlin_neighbourhood_singlebuckow_sf <- berlin_neighbourhood_sf %>%
  dplyr::filter(id != "Buckow") %>%
  rbind(buckow_sf) %>%
  sf::st_cast(to = 'MULTIPOLYGON')
```

## Map with Berlin vbb areas
VBB areas are the one related to public transportation.
Area A is delimited by the Ringbahn.
Area B starts from the Ringbahn and covers the rest of Berlin.
Area C will not be displayed since it is in Brandenburg.

# Create SpatialPolygons of all Berlin
```{r}
berlin_all_sf <- raster::aggregate(berlin,dissolve=TRUE) %>%
  sf::st_as_sf() %>%
  sf::st_set_crs(proj4string(berlin))
```

# Create SpatialPolygons for the Ringbahn (area A)
First of all, we load the shapefile containing the location of all stations and transport stops in Berlin
```{r}
stations <- raster::shapefile(file.path(getwd(), "berlin-latest-free", "gis_osm_transport_free_1.shp", fsep="/"))
```

Secondly, we extract the coordinates for the Ringbahn stations
```{r}
# Create DF out of SpatialPointsDataFrame
stations_df <- base::data.frame(stations) %>% 
  dplyr::rename(long = coords.x1, lat = coords.x2) %>%
  dplyr::mutate(name = gsub("Berlin ", "", name),
        name = gsub("Berlin-", "", name),
        name = gsub(" *\\(.*?\\) *", "", name)) %>%
  dplyr::select(fclass, name, long, lat)
  
# Create DF with Ringbahn stations and their order
# The initial station is repeated to have a full circle
ringbahn_names_df <- base::data.frame(name = c("Südkreuz", "Schöneberg", "Innsbrucker Platz", "Bundesplatz",
                    "Heidelberger Platz", "Hohenzollerndamm", "Halensee", "Westkreuz",
                    "Messe Nord/ICC", "Westend", "Jungfernheide", "Beusselstraße",
                    "Westhafen", "Wedding", "Gesundbrunnen", "Schönhauser Allee",
                    "Prenzlauer Allee", "Greifswalder Straße", "Landsberger Allee", 
                    "Storkower Straße", "Frankfurter Allee", "Ostkreuz", "Treptower Park",
                    "Sonnenallee", "Neukölln", "Hermannstraße",
                    "Tempelhof", "Südkreuz"),
                    stringsAsFactors = FALSE) %>% 
  tibble::rownames_to_column(var = "order") %>%
  dplyr::mutate(order = as.numeric(order))

# Select from the list of all stations those that are railway and whose name belongs to our Ringbahn names list and the rearrange according to the order we inserted before
ringbahn_df <- stations_df %>%
  dplyr::mutate(name = gsub("S ", "", name),
        name = gsub("U ", "", name)) %>%
  dplyr::filter(fclass %like% "railway" & name %in% ringbahn_names_df$name) %>%
  dplyr::group_by(name) %>%
  dplyr::summarize(long = mean(long), lat = mean(lat)) %>%
  dplyr::full_join(ringbahn_names_df, by = "name") %>%
  dplyr::arrange(order) 
```

Finally, we transform the coordinate points into a polygon
```{r}
# Create DF with just the coordinates
ringbahn_coordinates <- ringbahn_df %>% dplyr::select(long, lat) 
# Transform points into polygons
ringbahn_sf <- sp::SpatialPolygons(list(Polygons(list(Polygon(ringbahn_coordinates)),
                                             ID = "A")),
                               proj4string = CRS(proj4string(berlin))) %>% # Transform into spatial polygon
  sf::st_as_sf() 
```

# Create sf Object with areas A and B

```{r}
vbb_AB_sf <- base::rbind(ringbahn_sf, berlin_all_sf) %>%
  sf::st_intersection() %>% # Calculate intersections
  dplyr::mutate(id    = ifelse(n.overlaps > 1, "A", "B"), # Define IDs for different areas
                view  = "VBB Areas",
                group = id) %>% 
  dplyr::select(id, group, view, geometry) %>%
  dplyr::arrange(desc(id))

berlin_sf <- base::rbind(berlin_district_sf, vbb_AB_sf, berlin_neighbourhood_singlebuckow_sf) %>%
    sf::st_cast(to = 'MULTIPOLYGON')
```


# Map the SpatialPolygons with Leaflet
```{r}
# Names with coordinates
berlin_names <- berlin_sf %>%
  sf::st_centroid() %>%
  as.data.frame() %>%
  tidyr::extract(geometry, c("long", "lat"), "\\((.*), (.*)\\)", remove = TRUE) %>%
  dplyr::mutate(leaflet = gsub("-", "-<br/>", id),
                ggplot  = gsub("-", "- \n ", id),
                lat     = as.numeric(lat),
                long    = as.numeric(long))

vbb_B <- berlin_all_sf %>%
  st_bbox() %>%
  as.matrix() %>%
  t() %>%
  as.data.frame() %>%
  dplyr::transmute(long = (xmax + xmin)/2,
                   lat  = (3*ymax + ymin)/4) %>%
  dplyr::mutate(id = "B",
                group = id,
                view = "VBB Areas",
                leaflet = gsub("-", "-<br/>", id),
                ggplot  = gsub("-", "- \n ", id)) 

buckow <- berlin_neighbourhood_sf %>%
  dplyr::filter(id == "Buckow") %>%
  sf::st_centroid() %>%
  as.data.frame() %>%
  tidyr::extract(geometry, c("long", "lat"), "\\((.*), (.*)\\)", remove = TRUE) %>%
  dplyr::mutate(leaflet = gsub("-", "-<br/>", id),
                ggplot  = gsub("-", "- \n ", id),
                view    = "Neighbourhoods",
                lat     = as.numeric(lat),
                long    = as.numeric(long))

berlin_names <- berlin_names %>%
  filter(!id %in% c("B", "Buckow")) %>%
  rbind(vbb_B, buckow)

# leaflet
# colorlist = list("blue", "green", "yellow", "orange", "pink", "brown", "purple", "grey", "black", "darkblue", "khaki", "magenta")
leaflet() %>%
  addTiles() %>%
  addPolygons(data = berlin_sf %>% filter(view == "Districts"), weight = 1, smoothFactor = 1, fillOpacity = 0.8,
              fillColor = rainbow_hcl(12), color = "grey") %>%
  addLabelOnlyMarkers(data = berlin_names %>% filter(view == "Districts"),
                    lng = ~long, lat = ~lat, label = ~lapply(leaflet, htmltools::HTML),
                    labelOptions = labelOptions(noHide = TRUE, direction = 'center',
                                                textOnly = TRUE, textsize = "11px"))

# Leaflet.markercluster
# From: https://github.com/Leaflet/Leaflet.markercluster
# https://rpubs.com/bhaskarvk/leaflet-marker-clusterming


leaflet() %>%
  addTiles() %>%
  addPolygons(data = berlin_sf %>% filter(group == "Neukölln",
                                          view == "Neighbourhoods"), 
              weight = 1, smoothFactor = 1, fillOpacity = 0.8,
              fillColor = rainbow_hcl(6), color = "grey") %>%
  addLabelOnlyMarkers(data = berlin_names %>% filter(group == "Neukölln", view == "Neighbourhoods"),
                    lng = ~long, lat = ~lat, label = ~lapply(leaflet, htmltools::HTML),
                    labelOptions = labelOptions(noHide = TRUE, direction = 'center',
                                                textOnly = TRUE, textsize = "11px")) %>%
  addAwesomeMarkers(data = listings %>% filter(district == "Neukölln"),
             lng = ~long, lat = ~lat,
             icon = makeAwesomeIcon(icon = "eye-open", markerColor = "blue"),
             clusterOptions = markerClusterOptions(
               iconCreateFunction = JS("function (cluster) {var childCount = cluster.getChildCount();
.marker-mycluster div {
background-color: rgba(255,191,84, 1);
}
        return new L.DivIcon({ html: '<div><span>' + childCount + '</span></div>', className: 'marker-cluster marker-mycluster', iconSize: new L.Point(40, 40) });
    }
                                                }"),
                        singleMarkerMode = TRUE)
             ) %>%
  addMiniMap(centerFixed = berlin_center %>% t() %>% c(),
             zoomLevelFixed = 8,
             zoomAnimation = FALSE) 

%>%
  htmlwidgets::onRender("var style = document.createElement('style');
  style.type = 'text/css';
  style.innerHTML = '.red, .red div { background-color: rgba(255,0,0,0.6); }'; // set both at the same time
  document.getElementsByTagName('head')[0].appendChild(style);")

berlin_center %>% t() %>% c()  
  
# ggplot
ggplot() + 
  geom_sf(data = berlin_district_sf, show.legend = FALSE) +
  coord_sf(datum = NA) +
  aes(fill = id) +
  geom_text(data = districts, aes(x = long, y = lat, label = ggplot, hjust = "center"), size = 3.5) + 
  theme_void()
```

# Map the VBB areas A and B with Leaflet
```{r}
leaflet() %>%
  addTiles() %>%
  addPolygons(data = berlin_sf %>% filter(view == "VBB Areas"), weight = 1, fillColor = c("skyblue", "orange"), 
              col = c("blue", "brown"),
              opacity = 1.0, fillOpacity = 0.8) %>%
  addLabelOnlyMarkers(data = berlin_names %>% filter(view == "VBB Areas"),
                    lng = ~long, lat = ~lat, label = ~lapply(id, htmltools::HTML),
                    labelOptions = labelOptions(noHide = TRUE, direction = 'center',
                                                textOnly = TRUE, textsize = "20px")) %>%
  setView(lng = berlin_center$long, lat = berlin_center$lat, zoom = 10)
```

```{r}
rm("ringbahn_df", "ringbahn_names_df", "ringbahn_sf", "berlin", "ringbahn_coordinates",
   "stations", "buckow", "buckow_sf", "berlin_neighbourhood_singlebuckow_sf", "vbb_B", "berlin_all_sf")
```
